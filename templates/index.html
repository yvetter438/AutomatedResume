{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Header -->
    <header class="page-header">
        <h1>Experience</h1>
        <p class="page-subtitle">Your professional history and accomplishments</p>
    </header>
    
    <!-- Jobs Section -->
    <section class="jobs-section">
        {% if jobs %}
        <div class="job-list" ondragover="dragOver(event)" ondrop="updateOrder()">
            {% for job in jobs %}
            <article class="job-card"
                     draggable="true"
                     ondragstart="dragStart(event)"
                     ondragend="dragEnd(event)"
                     data-job-id="{{ job.id }}"
                     id="job-{{ job.id }}">
                
                <div class="job-header">
                    <div class="job-title-section">
                        <h3>{{ job.title }}</h3>
                        <span class="company-name">{{ job.company }}</span>
                    </div>
                    <div class="job-actions">
                        <button type="button" class="edit-button" onclick="editJob({{ job.id }})">
                            <i class="fas fa-pen"></i>
                        </button>
                        <form action="{{ url_for('delete_job', job_id=job.id) }}" method="POST" class="delete-job" onsubmit="return confirm('Delete this job?')">
                            <button type="submit" class="delete-button">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="job-meta">
                    <span class="meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ job.location }}
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-calendar-alt"></i>
                        {{ job.dates }}
                    </span>
                </div>
                
                <ul id="points-{{ job.id }}" 
                    class="points-list" 
                    ondragover="dragOverPoint(event, {{ job.id }})" 
                    ondrop="updatePointOrder({{ job.id }})">
                    {% for point in job.points %}
                    <li class="point-item"
                        draggable="true"
                        ondragstart="dragStartPoint(event)"
                        ondragend="dragEndPoint(event)"
                        data-point-id="{{ job.point_ids[loop.index0] }}"
                        id="point-{{ job.point_ids[loop.index0] }}">
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <span class="point-text">{{ point }}</span>
                        <form action="{{ url_for('delete_point', point_id=job.point_ids[loop.index0]) }}" method="POST" class="delete-point">
                            <button type="submit" class="delete-button small">
                                <i class="fas fa-times"></i>
                            </button>
                        </form>
                    </li>
                    {% endfor %}
                </ul>
                
                <!-- Add Point Form -->
                <form action="{{ url_for('add_point', job_id=job.id) }}" method="POST" class="add-point-form">
                    <input type="text" name="point" placeholder="Add a bullet point..." required>
                    <button type="submit">
                        <i class="fas fa-plus"></i>
                    </button>
                </form>
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-briefcase"></i>
            <h3>No experience added yet</h3>
            <p>Click the <strong>+</strong> button to add your first job</p>
        </div>
        {% endif %}
    </section>
</div>

<!-- New Job Modal -->
<div id="newJobModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeNewJobModal()">&times;</span>
        <h2 class="modal-title">Add Experience</h2>
        
        <form action="{{ url_for('create_job') }}" method="POST" id="jobForm">
            <div class="form-group">
                <label for="title">Job Title</label>
                <input type="text" id="title" name="title" placeholder="e.g. Software Engineer" required>
            </div>
            
            <div class="form-group">
                <label for="company">Company</label>
                <input type="text" id="company" name="company" placeholder="e.g. Google" required>
            </div>
            
            <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" placeholder="e.g. San Francisco, CA" required>
            </div>
            
            <div class="form-row">
                <div class="form-group date-group">
                    <label for="start_date">Start Date</label>
                    <input type="month" id="start_date" name="start_date" required>
                </div>
                
                <div class="form-group date-group">
                    <label for="end_date">End Date</label>
                    <input type="month" id="end_date" name="end_date">
                </div>
            </div>
            
            <label class="current-checkbox">
                <input type="checkbox" name="current" id="current" onchange="toggleEndDate()">
                <span>I currently work here</span>
            </label>
            
            <div class="form-group">
                <label>Accomplishments & Responsibilities</label>
                <div id="points-container">
                    <div class="point-input-group">
                        <input type="text" name="points[]" placeholder="e.g. Led a team of 5 engineers to deliver..." required>
                        <button type="button" class="remove-point" onclick="removePoint(this)" style="display: none;">×</button>
                    </div>
                </div>
                <button type="button" onclick="addPoint()" class="add-point-button">
                    <i class="fas fa-plus"></i>
                    Add Another
                </button>
            </div>
            
            <button type="submit" class="submit-button">
                <i class="fas fa-check"></i>
                Save Experience
            </button>
        </form>
    </div>
</div>

<style>
/* Experience Page Specific Styles */
.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-header h1 {
    margin-bottom: 8px;
}

.page-subtitle {
    color: var(--text-secondary);
    font-size: 1rem;
}

/* Job Card Improvements */
.job-card {
    position: relative;
}

.job-card::before {
    display: none; /* Remove the left border indicator */
}

.job-title-section {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.job-title-section h3 {
    margin: 0;
    font-size: 1.15rem;
}

.company-name {
    color: var(--accent-primary);
    font-weight: 500;
    font-size: 0.95rem;
}

.job-meta {
    display: flex;
    gap: 20px;
    margin: 12px 0 16px 0;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-muted);
    font-size: 0.85rem;
}

.meta-item i {
    font-size: 0.8rem;
    opacity: 0.7;
}

.job-actions {
    display: flex;
    gap: 8px;
}

.edit-button,
.job-actions .delete-button {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-default);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.edit-button:hover {
    background: var(--bg-tertiary);
    color: var(--accent-primary);
    border-color: var(--accent-primary);
}

.job-actions .delete-button:hover {
    background: rgba(248, 81, 73, 0.1);
    color: var(--accent-danger);
    border-color: var(--accent-danger);
}

/* Points List */
.point-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
    border: 1px solid transparent;
    transition: all var(--transition-fast);
}

.point-item:hover {
    border-color: var(--border-default);
}

.drag-handle {
    color: var(--text-muted);
    opacity: 0.4;
    cursor: grab;
    padding-top: 2px;
}

.point-item:hover .drag-handle {
    opacity: 0.8;
}

.point-text {
    flex: 1;
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.5;
}

.point-item .delete-button.small {
    width: 24px;
    height: 24px;
    padding: 0;
    opacity: 0;
    transition: opacity var(--transition-fast);
}

.point-item:hover .delete-button.small {
    opacity: 1;
}

/* Add Point Form */
.add-point-form {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.add-point-form input {
    flex: 1;
    padding: 10px 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.9rem;
}

.add-point-form input:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.add-point-form button {
    width: 40px;
    height: 40px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.add-point-form button:hover {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 80px 40px;
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px dashed var(--border-default);
}

.empty-state i {
    font-size: 3rem;
    color: var(--text-muted);
    opacity: 0.3;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.empty-state p {
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Modal Improvements */
.modal-title {
    font-size: 1.5rem;
    margin-bottom: 24px;
    color: var(--text-primary);
}

.submit-button {
    width: 100%;
    padding: 14px 24px;
    background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
    border: none;
    border-radius: var(--radius-md);
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 24px;
    transition: all var(--transition-fast);
}

.submit-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}
</style>

<script>
// ============================================
// Drag and Drop - Jobs
// ============================================

function dragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.id);
    e.target.classList.add('dragging');
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function dragOver(e) {
    e.preventDefault();
    const draggable = document.querySelector('.dragging');
    if (!draggable) return;
    
    const container = document.querySelector('.job-list');
    const siblings = [...container.querySelectorAll('.job-card:not(.dragging)')];
    
    const nextSibling = siblings.find(sibling => {
        const box = sibling.getBoundingClientRect();
        const offset = e.clientY - box.top - box.height / 2;
        return offset < 0;
    });
    
    if (nextSibling) {
        container.insertBefore(draggable, nextSibling);
    } else {
        container.appendChild(draggable);
    }
}

function updateOrder() {
    const jobs = document.querySelectorAll('.job-card');
    const orderData = Array.from(jobs).map((job, index) => ({
        id: job.dataset.jobId,
        order: index + 1
    }));

    fetch('/update-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jobs: orderData })
    });
}

// ============================================
// Drag and Drop - Points
// ============================================

function dragStartPoint(e) {
    e.stopPropagation();
    e.dataTransfer.setData('text/plain', e.target.id);
    e.target.classList.add('dragging-point');
}

function dragEndPoint(e) {
    e.target.classList.remove('dragging-point');
}

function dragOverPoint(e, jobId) {
    e.preventDefault();
    e.stopPropagation();
    const draggable = document.querySelector('.dragging-point');
    if (!draggable) return;
    
    const container = document.querySelector(`#points-${jobId}`);
    const siblings = [...container.querySelectorAll('.point-item:not(.dragging-point)')];
    
    const nextSibling = siblings.find(sibling => {
        const box = sibling.getBoundingClientRect();
        const offset = e.clientY - box.top - box.height / 2;
        return offset < 0;
    });
    
    if (nextSibling) {
        container.insertBefore(draggable, nextSibling);
    } else {
        container.appendChild(draggable);
    }
}

function updatePointOrder(jobId) {
    const points = document.querySelectorAll(`#points-${jobId} .point-item`);
    const orderData = Array.from(points).map((point, index) => ({
        id: point.dataset.pointId,
        order: index + 1
    }));

    fetch(`/update-point-order/${jobId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ points: orderData })
    });
}

// ============================================
// Modal Functions
// ============================================

function showNewJobModal() {
    document.getElementById('newJobModal').style.display = 'block';
}

function closeNewJobModal() {
    document.getElementById('newJobModal').style.display = 'none';
}

function editJob(jobId) {
    // TODO: Implement edit functionality
    console.log('Edit job:', jobId);
}

// ============================================
// Form Helpers
// ============================================

function toggleEndDate() {
    const endDate = document.getElementById('end_date');
    const isPresent = document.getElementById('current').checked;
    
    endDate.disabled = isPresent;
    if (isPresent) {
        endDate.value = '';
    }
}

function addPoint() {
    const container = document.getElementById('points-container');
    const newPoint = document.createElement('div');
    newPoint.className = 'point-input-group';
    newPoint.innerHTML = `
        <input type="text" name="points[]" placeholder="e.g. Increased sales by 25% through..." required>
        <button type="button" class="remove-point" onclick="removePoint(this)">×</button>
    `;
    container.appendChild(newPoint);
    
    const removeButtons = container.querySelectorAll('.remove-point');
    removeButtons.forEach(button => button.style.display = removeButtons.length > 1 ? 'flex' : 'none');
}

function removePoint(button) {
    const container = document.getElementById('points-container');
    button.parentElement.remove();
    
    const removeButtons = container.querySelectorAll('.remove-point');
    if (removeButtons.length === 1) {
        removeButtons[0].style.display = 'none';
    }
}
</script>
{% endblock %}
